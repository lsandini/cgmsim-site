<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://lsandini.github.io/cgmsim-site/operate/pump/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Pump mode and DIYAPS - CGMSIM</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../stylesheets/admonitions.css" rel="stylesheet" />
        <link href="../../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Pump mode and DIYAPS";
        var mkdocs_page_input_path = "operate/pump.md";
        var mkdocs_page_url = "/cgmsim-site/operate/pump/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-9DEJWGQQJ5"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-9DEJWGQQJ5');
      </script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../..">
          <img src="../../logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Mathematical Model</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../model/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../model/mealtime/">Mealtime Insulin</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../model/la-agonists/">Long-acting insulin Agonists</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../model/food/">Carb absorption from the gut</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../model/liver/">Endogenous Glucose production</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../model/physical/">Physical activity</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../model/random/">Random variation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Installation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../build/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build/nightscout/">Nightscout</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build/linux/">Linux/Ubuntu</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build/clone/">Download</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build/setupscript/">Setup script</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../build/kickstart/">Kickstart</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Using the simulator</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../meals/">Declaring meals and mealtime insulin</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../insulin/">Declaring long-acting insulins</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Pump mode and DIYAPS</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#nightscout-setup">Nightscout setup</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cgmsim-setup">CGMSIM setup</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#timezone-issue-on-cloud-based-linux-vms">Timezone issue on cloud-based Linux VMs</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#surprise-meals">Surprise meals</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../reports/">View reports</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../contact/">Contact me</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">CGMSIM</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Using the simulator &raquo;</li>
      <li>Pump mode and DIYAPS</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="insulin-pump-mode-and-diyaps">Insulin pump mode and DIYAPS<a class="headerlink" href="#insulin-pump-mode-and-diyaps" title="Permanent link">‚åÅ</a></h1>
<div class="admonition warning">
<p class="admonition-title">Nerdy stuff ahead !</p>
<p>This has not been yet fully tested, and you might encounter a few üêõ along the way. You have been warned !</p>
</div>
<p>While this simulator was built as a training tool for Multiple Daily Injection (MDI) treatment, it can also be used to simulate Continuous Subcutaneous Insulin Infusion (CSII) or more familiarly "insulin pump" therapy. Moreover, it can be coupled to a DIYAPS solution as <a href="https://openaps.org">openAPS</a>.</p>
<p>I have been doing this for a while on a "custom" setup, but now I added the required files to the repository for all to use. In the live demo below, there might be downtime now and then, when the rig is powered down or the pump reservoir is empty.</p>
<p><span style="text-decoration: underline"><strong>THIS IS A LIVE UNATTENDED CGMSIM PATIENT TAKEN CARE OF BY OPENAPS : </strong></span></p>
<iframe style="width: 640px; height: 480px; overflow: hidden;"  scrolling="no" frameborder="0" src="https://dmpkl-freeaps.herokuapp.com/"></iframe>
<p><br></p>
<h2 id="nightscout-setup">Nightscout setup<a class="headerlink" href="#nightscout-setup" title="Permanent link">‚åÅ</a></h2>
<p>First of all, make sure that your instance of Nightscout is set to be used with DIAPS systems. It involves adding a few terms in the ENABLE variable of Heroku. You will want to see a pillbox with details about the APS calculations and another one with details about the pumps activity.</p>
<p><a href="https://openaps.readthedocs.io/en/latest/docs/While%20You%20Wait%20For%20Gear/nightscout-setup.html">Details on how to setup Nightscout for openAPS here.</a></p>
<p><a href="https://loopkit.github.io/loopdocs/nightscout/update_user/">Details on how to setup Nightscout for iOS Loop here.</a></p>
<p><br></p>
<h2 id="cgmsim-setup">CGMSIM setup<a class="headerlink" href="#cgmsim-setup" title="Permanent link">‚åÅ</a></h2>
<p>A couple of modifications are required in order to compute the insulin activity based on what the pump has been administrating. The calculations include the insulin activity from basal rates and from boluses, and not mealtime doses and long-acting agonists anymore.</p>
<p>If you have built an openAPS rig, it will read the pump's memory, and upload the basal profile, other settings and bolus history to Nightscout. We will first setup CGMSIM to download that data from Nightscout.</p>
<p>If you need more info on how to modify your crontab, please check <a href="https://crontab.guru/">crontab.guru</a> !</p>
<p><strong>In the suggested crontab for MDI mode, there were 4 lines :</strong></p>
<pre><code>SHELL=/bin/bash
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

0 */6 * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash perlin.sh
*/5 * * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash get-all.sh
*/5 * * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash upload-cgmsim.sh
#30 23 * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash surprise.sh
</code></pre>
<p><br>
Lines starting with <strong>#</strong> are commented out and will not be executed. Remove the <strong>#</strong> to activate them !</p>
<div class="admonition danger">
<p class="admonition-title">You will need to:</p>
<ul>
<li>
<p>Add a first line pointing to <strong>get-pump.sh</strong>, so that CGMSIM will download pump data from NS  </p>
</li>
<li>
<p>Edit the 4th line, so that CGMSIM will upload SGVs based on pump insulin: <strong>upload-cgmsim-pump.sh</strong>  </p>
</li>
<li>
<p>Add the 5th line if you want to run your rig unattended with meals issued automatically with matching boluses</p>
</li>
</ul>
</div>
<p><br>  </p>
<p><strong>It should now look like this :</strong></p>
<pre><code>SHELL=/bin/bash
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

*/5 * * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash get-pump.sh
0 */6 * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash perlin.sh
*/5 * * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash get-all.sh
*/5 * * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash upload-cgmsim-pump.sh
#0 0 * * * cd /home/MYUSERNAME/cgmsim &amp;&amp;/bin/bash random_meal.sh
#30 23 * * * cd /home/MYUSERNAME/cgmsim &amp;&amp; /bin/bash surprise.sh
</code></pre>
<p><br></p>
<h3 id="timezone-issue-on-cloud-based-linux-vms">Timezone issue on cloud-based Linux VMs<a class="headerlink" href="#timezone-issue-on-cloud-based-linux-vms" title="Permanent link">‚åÅ</a></h3>
<p>The 5th line specifically triggers the execution of the bash script <strong>random_meal.sh</strong> at midnight 00:00 or 12PM. The 4 meals of the next day are computed (carb amounts and time of delivery).  These are saved in a file, that will be overwritten the next time the script runs, 24 hours later.</p>
<p>The absolute time of the script execution refers to the <strong>timezone where your computer running CGMSIM is located</strong>. If you are using a cloud-based solution, notice the time difference with your location. </p>
<p>For me, with a DigitalOcean droplet located in Europe, the time difference is +3 hours. So I execute the sript at 21:00 o'clock "server time", which is 24:00 at my location. The line starts with :</p>
<pre><code>#0 21 * * * cd /home ...
</code></pre>
<p>If you are running CGMSIM on a local machine and running the script at midnight, then the line should start with :</p>
<pre><code>#0 0 * * * cd /home ...
</code></pre>
<p>Finally, you have to <strong>uncomment</strong> a line in one of the scripts. Edit <strong>get-all.sh</strong> by typing:</p>
<pre><code>nano get-all.sh
</code></pre>
<p>... and remove the <strong>#</strong> in front of:</p>
<pre><code># node random_meal_upload.js  
</code></pre>
<p>Then save your changes. Voil√†.
<br>
<br></p>
<h2 id="surprise-meals">Surprise meals<a class="headerlink" href="#surprise-meals" title="Permanent link">‚åÅ</a></h2>
<p>Just as a reminder, the <strong>"surprise"</strong> feature on the 6th and last line of the crontab creates an automatic meal completing the 200g carbs daily goal at 11:30PM. No automatic bolus, so your "late snack" remains untreated. Use with caution üòÑ</p>
<p><br>
<br></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../insulin/" class="btn btn-neutral float-left" title="Declaring long-acting insulins"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../reports/" class="btn btn-neutral float-right" title="View reports">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../insulin/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../reports/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../javascripts/config.js" defer></script>
      <script src="../../javascripts/extra.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
